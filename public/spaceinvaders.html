<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Invaders</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Centering */
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }

        canvas {
            display: block;
            background-color: #000;
            box-shadow: 0 0 10px 5px #0f0, 0 0 15px 10px #0f0 inset;
            border: 2px solid #0f0;
            border-radius: 8px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            max-width: 100%;
            max-height: 80vh;
            aspect-ratio: 4 / 3;
        }

        .game-controls {
            margin-top: 20px;
            text-align: center;
        }

        .game-controls button {
            background-color: #222;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 10px;
            box-shadow: 0 0 5px #0f0;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .game-controls button:hover, .game-controls button:focus {
            background-color: #111;
            box-shadow: 0 0 10px #0f0, 0 0 5px #0f0 inset;
        }

        .game-controls button:active {
            transform: translateY(2px);
        }

        #scoreBoard, #livesBoard {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #0f0;
        }

        #messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 30px;
            border: 3px solid #0f0;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 15px #0f0;
            display: none;
        }

        #messageBox h1 {
            font-size: 2rem;
            color: #0f0;
            margin-bottom: 15px;
        }

        #messageBox p {
            font-size: 1rem;
            margin-bottom: 20px;
        }

        #messageBox button {
            background-color: #0f0;
            color: #000;
            border: none;
            padding: 12px 25px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s, transform 0.2s;
        }

        #messageBox button:hover {
            background-color: #3f3;
            transform: scale(1.05);
        }

        #touchControls {
            display: none;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            justify-content: space-between;
        }

        #touchControls button {
            font-size: 1.5rem;
            padding: 15px 20px;
            width: 30%;
        }

        @media (max-width: 600px) {
            #touchControls {
                display: flex;
            }
            .game-controls button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            #messageBox h1 {
                font-size: 1.5rem;
            }
            #messageBox p {
                font-size: 0.9rem;
            }
            #messageBox button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="scoreBoard">Score: 0</div>
    <div id="livesBoard">Lives: 3</div>

    <canvas id="gameCanvas"></canvas>

    <div id="messageBox">
        <h1 id="messageTitle">Space Invaders</h1>
        <p id="messageText">Press Start to play!</p>
        <button id="messageButton">Start Game</button>
    </div>

    <div id="touchControls">
        <button id="touchLeft">‚¨ÖÔ∏è</button>
        <button id="touchFire">üî•</button>
        <button id="touchRight">‚û°Ô∏è</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const scoreBoard = document.getElementById('scoreBoard');
        const livesBoard = document.getElementById('livesBoard');
        const finalScoreDisplay = document.getElementById('finalScore');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messageButton = document.getElementById('messageButton');

        let player, invaders, bullets, alienBullets, barriers, ufo;
        let score = 0;
        let lives = 3;
        let gameState = 'waiting'; // 'waiting', 'running', 'over'
        let alienDirection = 1;
        let alienSpeed = 0.5;
        let alienDropDistance = 20;
        let alienShootInterval = 1000;
        let lastAlienShotTime = 0;
        const baseAlienSpeed = 0.5;
        const speedIncreasePerKill = 0.01;
        let ufoSpawnTimer = 0;
        const ufoSpawnInterval = 15000;

        const playerWidth = 50;
        const playerHeight = 30;
        const playerSpeed = 5;
        const bulletWidth = 5;
        const bulletHeight = 15;
        const bulletSpeed = 7;
        const alienRows = 5;
        const alienCols = 10;
        const alienWidth = 30;
        const alienHeight = 20;
        const alienPadding = 10;
        const alienOffsetTop = 30;
        const alienOffsetLeft = 30;
        const barrierCount = 4;
        const barrierWidth = 70;
        const barrierHeight = 30;
        const barrierSegmentSize = 10;
        const ufoWidth = 45;
        const ufoHeight = 20;
        const ufoSpeed = 2;
        const ufoColor = '#ff0000';
        const ufoPoints = 100;

        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            Space: false
        };

        let lastResizeTime = 0;
        const resizeDebounce = 200; // Debounce resize events (ms)

        function resizeCanvas() {
            const now = Date.now();
            if (now - lastResizeTime < resizeDebounce) return;
            lastResizeTime = now;

            const aspectRatio = 4 / 3;
            let newWidth = window.innerWidth * 0.9;
            let newHeight = newWidth / aspectRatio;

            if (newHeight > window.innerHeight * 0.7) {
                newHeight = window.innerHeight * 0.7;
                newWidth = newHeight * aspectRatio;
            }
            canvas.width = Math.floor(newWidth);
            canvas.height = Math.floor(newHeight);

            if (gameState === 'running') {
                const currentScore = score;
                const currentLives = lives;
                const ufoActive = ufo && ufo.alive;
                initGame(false); // Don't reset score/lives
                score = currentScore;
                lives = currentLives;
                updateScoreboard();
                updateLivesBoard();
                if (ufoActive) ufo = createUFO();
            }
        }

        function createPlayer() {
            return {
                x: canvas.width / 2 - playerWidth / 2,
                y: canvas.height - playerHeight - 20,
                width: playerWidth,
                height: playerHeight,
                color: '#0f0'
            };
        }

        function createInvader(x, y, type) {
            return {
                x, y, width: alienWidth, height: alienHeight,
                color: type === 1 ? '#f0f' : (type === 2 ? '#0ff' : '#ff0'),
                type, alive: true
            };
        }

        function createBullet(x, y, color, velocityY) {
            return { x, y, width: bulletWidth, height: bulletHeight, color, velocityY };
        }

        function createBarrierSegment(x, y) {
            return { x, y, width: barrierSegmentSize, height: barrierSegmentSize, color: '#0c0', hits: 0, maxHits: 3, alive: true };
        }

        function createUFO() {
            const direction = Math.random() < 0.5 ? 1 : -1;
            return {
                x: direction === 1 ? -ufoWidth : canvas.width,
                y: alienOffsetTop / 2,
                width: ufoWidth,
                height: ufoHeight,
                speed: ufoSpeed * direction,
                color: ufoColor,
                alive: true,
                points: ufoPoints
            };
        }

        function initBarriers() {
            barriers = [];
            const barrierSpacing = (canvas.width - (barrierCount * barrierWidth)) / (barrierCount + 1);
            const barrierY = canvas.height - playerHeight - 80;

            for (let i = 0; i < barrierCount; i++) {
                const barrierX = barrierSpacing * (i + 1) + barrierWidth * i;
                const barrier = [];
                for (let r = 0; r < barrierHeight / barrierSegmentSize; r++) {
                    for (let c = 0; c < barrierWidth / barrierSegmentSize; c++) {
                        barrier.push(createBarrierSegment(
                            barrierX + c * barrierSegmentSize,
                            barrierY + r * barrierSegmentSize
                        ));
                    }
                }
                barriers.push(barrier);
            }
        }

        function initGame(resetScoreLives = true) {
            player = createPlayer();
            invaders = [];
            bullets = [];
            alienBullets = [];
            ufo = null;
            ufoSpawnTimer = Date.now();
            if (resetScoreLives) {
                score = 0;
                lives = 3;
            }
            alienDirection = 1;
            alienSpeed = baseAlienSpeed;
            lastAlienShotTime = 0;
            updateScoreboard();
            updateLivesBoard();
            gameState = 'running';

            for (let row = 0; row < alienRows; row++) {
                for (let col = 0; col < alienCols; col++) {
                    const alienX = alienOffsetLeft + col * (alienWidth + alienPadding);
                    const alienY = alienOffsetTop + row * (alienHeight + alienPadding);
                    const type = (row % 3) + 1;
                    invaders.push(createInvader(alienX, alienY, type));
                }
            }
            initBarriers();
        }

        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.closePath();
            ctx.fill();
        }

        function drawInvaders() {
            invaders.forEach(invader => {
                if (invader.alive) {
                    ctx.fillStyle = invader.color;
                    ctx.fillRect(invader.x, invader.y, invader.width, invader.height);
                    ctx.fillStyle = 'black';
                    ctx.fillRect(invader.x + invader.width * 0.2, invader.y + invader.height * 0.2, 4, 4);
                    ctx.fillRect(invader.x + invader.width * 0.6, invader.y + invader.height * 0.2, 4, 4);
                }
            });
        }

        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
            alienBullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
        }

        function drawBarriers() {
            barriers.forEach(barrier => {
                barrier.forEach(segment => {
                    if (segment.alive) {
                        const opacity = 1 - (segment.hits / segment.maxHits) * 0.7;
                        ctx.fillStyle = `rgba(0, 204, 0, ${opacity})`;
                        ctx.fillRect(segment.x, segment.y, segment.width, segment.height);
                    }
                });
            });
        }

        function drawUFO() {
            if (ufo && ufo.alive) {
                ctx.fillStyle = ufo.color;
                ctx.beginPath();
                ctx.ellipse(ufo.x + ufo.width / 2, ufo.y + ufo.height / 2, ufo.width / 2, ufo.height / 2, 0, Math.PI, 2 * Math.PI);
                ctx.lineTo(ufo.x + ufo.width, ufo.y + ufo.height);
                ctx.lineTo(ufo.x, ufo.y + ufo.height);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.ellipse(ufo.x + ufo.width / 2, ufo.y + ufo.height * 0.4, ufo.width * 0.3, ufo.height * 0.25, 0, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        function updatePlayer() {
            if (keys.ArrowLeft && player.x > 0) player.x -= playerSpeed;
            if (keys.ArrowRight && player.x < canvas.width - player.width) player.x += playerSpeed;
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y += bullets[i].velocityY;
                if (bullets[i].y < 0) bullets.splice(i, 1);
            }
            for (let i = alienBullets.length - 1; i >= 0; i--) {
                alienBullets[i].y += alienBullets[i].velocityY;
                if (alienBullets[i].y > canvas.height) alienBullets.splice(i, 1);
            }
        }

        function updateInvaders() {
            let moveDown = false;
            invaders.forEach(invader => {
                if (invader.alive) {
                    invader.x += alienSpeed * alienDirection;
                    if (invader.x + invader.width > canvas.width || invader.x < 0) moveDown = true;
                    if (invader.y + invader.height >= player.y) {
                        gameOver();
                        return;
                    }
                }
            });

            if (moveDown) {
                alienDirection *= -1;
                invaders.forEach(invader => {
                    if (invader.alive) invader.y += alienDropDistance;
                });
            }

            const currentTime = Date.now();
            if (currentTime - lastAlienShotTime > alienShootInterval) {
                const shootingInvaders = invaders.filter(inv => inv.alive);
                if (shootingInvaders.length > 0) {
                    const randomInvader = shootingInvaders[Math.floor(Math.random() * shootingInvaders.length)];
                    alienBullets.push(createBullet(
                        randomInvader.x + randomInvader.width / 2 - bulletWidth / 2,
                        randomInvader.y + randomInvader.height, '#f00', bulletSpeed / 1.5
                    ));
                    lastAlienShotTime = currentTime;
                }
            }
        }

        function updateUFO() {
            const currentTime = Date.now();
            if (!ufo && currentTime - ufoSpawnTimer > ufoSpawnInterval) {
                if (Math.random() < 0.3) {
                    ufo = createUFO();
                }
                ufoSpawnTimer = currentTime;
            }
            if (ufo && ufo.alive) {
                ufo.x += ufo.speed;
                if ((ufo.speed > 0 && ufo.x > canvas.width) || (ufo.speed < 0 && ufo.x + ufo.width < 0)) {
                    ufo = null;
                }
            }
        }

        function checkCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                for (let j = invaders.length - 1; j >= 0; j--) {
                    if (invaders[j].alive && bullets[i] &&
                        bullets[i].x < invaders[j].x + invaders[j].width &&
                        bullets[i].x + bullets[i].width > invaders[j].x &&
                        bullets[i].y < invaders[j].y + invaders[j].height &&
                        bullets[i].y + bullets[i].height > invaders[j].y) {
                        invaders[j].alive = false;
                        bullets.splice(i, 1);
                        score += 10 * invaders[j].type;
                        updateScoreboard();
                        alienSpeed += speedIncreasePerKill;
                        break;
                    }
                }
            }

            if (ufo && ufo.alive) {
                for (let i = bullets.length - 1; i >= 0; i--) {
                    if (bullets[i].x < ufo.x + ufo.width &&
                        bullets[i].x + bullets[i].width > ufo.x &&
                        bullets[i].y < ufo.y + ufo.height &&
                        bullets[i].y + bullets[i].height > ufo.y) {
                        ufo.alive = false;
                        bullets.splice(i, 1);
                        score += ufo.points;
                        updateScoreboard();
                        ufo = null;
                        break;
                    }
                }
            }

            for (let i = alienBullets.length - 1; i >= 0; i--) {
                if (alienBullets[i].x < player.x + player.width &&
                    alienBullets[i].x + alienBullets[i].width > player.x &&
                    alienBullets[i].y < player.y + player.height &&
                    alienBullets[i].y + alienBullets[i].height > player.y) {
                    alienBullets.splice(i, 1);
                    lives--;
                    updateLivesBoard();
                    if (lives <= 0) gameOver();
                    break;
                }
            }

            const allBullets = [...bullets, ...alienBullets];
            for (let i = allBullets.length - 1; i >= 0; i--) {
                const bullet = allBullets[i];
                let bulletRemoved = false;
                for (let b = 0; b < barriers.length; b++) {
                    for (let s = barriers[b].length - 1; s >= 0; s--) {
                        const segment = barriers[b][s];
                        if (segment.alive && bullet &&
                            bullet.x < segment.x + segment.width &&
                            bullet.x + bullet.width > segment.x &&
                            bullet.y < segment.y + segment.height &&
                            bullet.y + bullet.height > segment.y) {
                            segment.hits++;
                            if (segment.hits >= segment.maxHits) segment.alive = false;
                            if (bullet.velocityY < 0) {
                                const bulletIndex = bullets.indexOf(bullet);
                                if (bulletIndex > -1) bullets.splice(bulletIndex, 1);
                            } else {
                                const bulletIndex = alienBullets.indexOf(bullet);
                                if (bulletIndex > -1) alienBullets.splice(bulletIndex, 1);
                            }
                            bulletRemoved = true;
                            break;
                        }
                    }
                    if (bulletRemoved) break;
                }
            }

            const aliveInvaders = invaders.filter(inv => inv.alive).length;
            if (aliveInvaders === 0 && gameState === 'running') gameWon();
        }

        function updateScoreboard() { scoreBoard.textContent = `Score: ${score}`; }
        function updateLivesBoard() { livesBoard.textContent = `Lives: ${lives}`; }

        function showMessage(title, text, buttonText, onButtonClick) {
            messageTitle.textContent = title;
            messageText.innerHTML = text;
            messageButton.textContent = buttonText;
            messageBox.style.display = 'block';
            messageButton.onclick = () => {
                hideMessage();
                if (onButtonClick) onButtonClick();
            };
        }

        function hideMessage() { messageBox.style.display = 'none'; }

        function showStartScreen() {
            gameState = 'waiting';
            showMessage(
                "Space Invaders",
                "Controls: ‚Üê ‚Üí to move, Space to shoot<br>Touch: ‚¨ÖÔ∏è ‚û°Ô∏è to move, üî• to shoot",
                "Start Game",
                () => {
                    initGame();
                    requestAnimationFrame(gameLoop);
                }
            );
        }

        function gameOver() {
            gameState = 'over';
            finalScoreDisplay.textContent = score;
            showMessage(
                "Game Over",
                `Your final score: <span id="finalScore">${score}</span>`,
                "Restart Game",
                () => {
                    initGame();
                    requestAnimationFrame(gameLoop);
                }
            );
        }

        function gameWon() {
            gameState = 'over';
            finalScoreDisplay.textContent = score;
            showMessage(
                "You Win!",
                `Congratulations! Your score: <span id="finalScore">${score}</span>`,
                "Play Again",
                () => {
                    initGame();
                    requestAnimationFrame(gameLoop);
                }
            );
        }

        function gameLoop(timestamp) {
            if (gameState !== 'running') {
                requestAnimationFrame(gameLoop);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            updatePlayer();
            updateBullets();
            updateInvaders();
            updateUFO();
            checkCollisions();
            drawPlayer();
            drawInvaders();
            drawBullets();
            drawBarriers();
            drawUFO();

            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('keydown', (e) => {
            if (gameState === 'waiting') return; // Ignore keys during waiting
            if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                if (gameState === 'running' && bullets.length < 5) {
                    bullets.push(createBullet(player.x + player.width / 2 - bulletWidth / 2, player.y, '#0f0', -bulletSpeed));
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
        });

        const touchLeftButton = document.getElementById('touchLeft');
        const touchRightButton = document.getElementById('touchRight');
        const touchFireButton = document.getElementById('touchFire');
        const touchControlsDiv = document.getElementById('touchControls');

        function isTouchDevice() { return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0); }

        if (isTouchDevice()) {
            touchControlsDiv.style.display = 'flex';
            touchLeftButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'waiting') return;
                keys.ArrowLeft = true;
            }, { passive: false });
            touchLeftButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowLeft = false;
            });
            touchRightButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'waiting') return;
                keys.ArrowRight = true;
            }, { passive: false });
            touchRightButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys.ArrowRight = false;
            });
            touchFireButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'waiting') return;
                if (gameState === 'running' && bullets.length < 5) {
                    bullets.push(createBullet(player.x + player.width / 2 - bulletWidth / 2, player.y, '#0f0', -bulletSpeed));
                }
            }, { passive: false });
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        showStartScreen();
    </script>
</body>
</html>
