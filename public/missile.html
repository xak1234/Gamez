<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Anal Command</title>
    <style>
        body {
            background: #000;
            color: #0ff;
            font-family: 'Press Start 2P', monospace, sans-serif;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #000;
        }
        #score {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            color: #0090ff;
            letter-spacing: 3px;
            font-family: 'Press Start 2P', monospace, sans-serif;
            text-shadow: 1px 1px #111, 0 0 8px #22f;
        }
    </style>
</head>
<body>
<div id="score"></div>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<audio id="sndLaunch" src="https://cdn.pixabay.com/audio/2022/07/26/audio_12ccefa48c.mp3" preload="auto"></audio>
<audio id="sndExplosion" src="https://cdn.pixabay.com/audio/2022/07/26/audio_123ef6f88d.mp3" preload="auto"></audio>
<audio id="sndLose" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124b6a3a44.mp3" preload="auto"></audio>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const w = canvas.width, h = canvas.height;

const CITY_NAMES = ["LEEDS", "YORK", "MANCHESTER", "ROTHERHAM", "BRADFORD"];
const NUM_CITIES = CITY_NAMES.length;
const LAUNCHER_POS = [100, 250, 400, 550, 700];
const MISSILES_PER_CITY = 50;
let cities = [];
let missiles = [];
let enemyMissiles = [];
let explosions = [];
let score = 0;
let gameOver = false;

// Sound
const sndLaunch = document.getElementById('sndLaunch');
const sndExplosion = document.getElementById('sndExplosion');
const sndLose = document.getElementById('sndLose');
function playSound(audio, rate=1) {
    try {
        audio.pause();
        audio.currentTime = 0;
        audio.playbackRate = rate;
        audio.play();
    } catch {}
}

// City positions (with missile count)
for (let i = 0; i < NUM_CITIES; i++) {
    cities.push({
        name: CITY_NAMES[i],
        x: LAUNCHER_POS[i],
        alive: true,
        missiles: MISSILES_PER_CITY
    });
}

// Factory/cityscape drawing BETWEEN cities
function drawCityBackground() {
    ctx.save();
    // Draw factory elements BETWEEN cities
    for (let i = 0; i < cities.length - 1; i++) {
        let x = (cities[i].x + cities[i+1].x) / 2;
        // Big smokestack
        ctx.fillStyle = "#444";
        ctx.fillRect(x - 10, h - 130, 18, 80);
        // Big factory block
        ctx.fillStyle = "#222";
        ctx.fillRect(x - 32, h - 70, 60, 35);
        // Warehouse front
        ctx.fillStyle = "#555";
        ctx.fillRect(x - 22, h - 40, 44, 20);
        // Windows/lights
        ctx.fillStyle = "#ffd700";
        for (let k = 0; k < 5; k++) {
            ctx.fillRect(x - 28 + k * 12, h - 60, 6, 10);
        }
        // Chimney smoke (cartoon)
        ctx.beginPath();
        ctx.arc(x, h - 140, 10, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(200,200,200,0.22)";
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x + 7, h - 152, 7, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(210,210,210,0.14)";
        ctx.fill();
    }
    ctx.restore();
}

function drawTitle() {
    ctx.save();
    ctx.font = "40px 'Press Start 2P', monospace";
    ctx.fillStyle = "#0ff";
    ctx.textAlign = "center";
    ctx.fillText("ANAL COMMAND", w / 2, 90);
    ctx.restore();
}

function drawCities() {
    ctx.save();
    ctx.font = "18px 'Press Start 2P', monospace";
    for (let i = 0; i < cities.length; i++) {
        if (cities[i].alive) {
            // City block
            ctx.fillStyle = "#0cf";
            ctx.fillRect(cities[i].x - 25, h - 70, 50, 40);
            // Launcher
            ctx.fillStyle = "#fa3";
            ctx.beginPath();
            ctx.arc(cities[i].x, h - 75, 12, Math.PI, 0);
            ctx.fill();
        }
        // City name
        ctx.font = "18px 'Press Start 2P', monospace";
        ctx.fillStyle = "#ff0";
        ctx.textAlign = "center";
        ctx.fillText(cities[i].name, cities[i].x, h - 15);

        // Missile number (UNDER city)
        ctx.font = "18px 'Press Start 2P', monospace";
        ctx.fillStyle = cities[i].alive
          ? (cities[i].missiles > 0 ? "#0cf" : "#f33")
          : "#222";
        ctx.fillText("â–² " + cities[i].missiles, cities[i].x, h - 5);
    }
    ctx.restore();
}

function drawMissiles() {
    // Player missiles
    ctx.strokeStyle = "#0f0";
    ctx.lineWidth = 2;
    for (const m of missiles) {
        ctx.beginPath();
        ctx.moveTo(m.x0, m.y0);
        ctx.lineTo(m.x, m.y);
        ctx.stroke();
    }
    // Enemy missiles
    ctx.strokeStyle = "#f00";
    for (const em of enemyMissiles) {
        ctx.beginPath();
        ctx.moveTo(em.x0, em.y0);
        ctx.lineTo(em.x, em.y);
        ctx.stroke();
    }
}

function drawExplosions() {
    for (const e of explosions) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.r, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        ctx.fill();
        ctx.restore();
    }
}

function drawGameOver() {
    ctx.save();
    ctx.font = "48px 'Press Start 2P', monospace";
    ctx.fillStyle = "#f00";
    ctx.textAlign = "center";
    ctx.fillText("GAME OVER", w / 2, h / 2);
    ctx.font = "32px 'Press Start 2P', monospace";
    ctx.fillStyle = "#ff0";
    ctx.fillText("Score: " + score, w / 2, h / 2 + 60);
    ctx.restore();
}

// Missile logic
function spawnEnemyMissile() {
    let aliveCities = cities.filter(c => c.alive);
    if (aliveCities.length === 0) return;
    let target = aliveCities[Math.floor(Math.random() * aliveCities.length)];
    let x0 = Math.random() * w;
    let y0 = 0;
    let x1 = target.x;
    let y1 = h - 70;
    let speed = 0.5 + Math.random() * 0.8; // SLOWER INCOMING!
    enemyMissiles.push({ x0, y0, x: x0, y: y0, x1, y1, speed });
}

function spawnPlayerMissile(targetX, targetY) {
    // Find closest alive launcher with ammo
    let minDist = Infinity, idx = -1;
    for (let i = 0; i < cities.length; i++) {
        if (cities[i].alive && cities[i].missiles > 0) {
            let d = Math.abs(cities[i].x - targetX);
            if (d < minDist) {
                minDist = d;
                idx = i;
            }
        }
    }
    if (idx === -1) return; // No city with ammo
    let x0 = cities[idx].x;
    let y0 = h - 75;
    let speed = 5;
    missiles.push({ x0, y0, x: x0, y: y0, x1: targetX, y1: targetY, speed });
    cities[idx].missiles--;
    playSound(sndLaunch, 1.2);
}

function updateMissiles() {
    // Player missiles
    for (let i = missiles.length - 1; i >= 0; i--) {
        let m = missiles[i];
        let dx = m.x1 - m.x, dy = m.y1 - m.y;
        let dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < m.speed) {
            // Explode
            explosions.push({ x: m.x1, y: m.y1, r: 1, maxR: 50, frame: 0 });
            playSound(sndExplosion);
            missiles.splice(i, 1);
            continue;
        }
        m.x += m.speed * dx / dist;
        m.y += m.speed * dy / dist;
    }
    // Enemy missiles
    for (let i = enemyMissiles.length - 1; i >= 0; i--) {
        let em = enemyMissiles[i];
        let dx = em.x1 - em.x, dy = em.y1 - em.y;
        let dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < em.speed) {
            // Hit!
            for (let city of cities) {
                if (city.alive && Math.abs(city.x - em.x1) < 28) {
                    city.alive = false;
                    playSound(sndExplosion, 0.7);
                    break;
                }
            }
            enemyMissiles.splice(i, 1);
            continue;
        }
        // Check for explosion collision
        for (let e of explosions) {
            let d = Math.sqrt((em.x - e.x) ** 2 + (em.y - e.y) ** 2);
            if (d < e.r) {
                score += 100;
                playSound(sndExplosion, 1.3);
                enemyMissiles.splice(i, 1);
                break;
            }
        }
        em.x += em.speed * dx / dist;
        em.y += em.speed * dy / dist;
    }
}

function updateExplosions() {
    for (let i = explosions.length - 1; i >= 0; i--) {
        let e = explosions[i];
        e.frame++;
        if (e.frame < 10) {
            e.r += 5;
        } else if (e.frame < 20) {
            e.r += 2;
        } else {
            e.r -= 4;
            if (e.r < 0) {
                explosions.splice(i, 1);
            }
        }
    }
}

// Main loop
function gameLoop() {
    ctx.clearRect(0, 0, w, h);
    document.getElementById("score").innerHTML = `Score: ${score}`;
    drawCityBackground();
    drawTitle();
    drawCities();
    drawMissiles();
    drawExplosions();
    if (gameOver) {
        drawGameOver();
        return;
    }
    updateMissiles();
    updateExplosions();

    // Lose check
    if (!cities.some(c => c.alive)) {
        if (!gameOver) playSound(sndLose, 0.9);
        gameOver = true;
    }

    requestAnimationFrame(gameLoop);
}

// Missile spawn interval
let missileInterval = setInterval(() => {
    if (!gameOver) spawnEnemyMissile();
}, 1100);

canvas.addEventListener('click', function(e) {
    if (gameOver) return;
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    if (y < h - 120) spawnPlayerMissile(x, y);
});

canvas.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    if (!gameOver) return;
    // Reset game
    cities = [];
    for (let i = 0; i < NUM_CITIES; i++) {
        cities.push({
            name: CITY_NAMES[i],
            x: LAUNCHER_POS[i],
            alive: true,
            missiles: MISSILES_PER_CITY
        });
    }
    missiles = [];
    enemyMissiles = [];
    explosions = [];
    score = 0;
    gameOver = false;
    gameLoop();
});

gameLoop();
</script>
</body>
</html>
